#include "device.h"

void low_uart_put(int ch) {
    while ( !((*uart_reg0) & 0x20) )
    {}

    *uart_reg1 = ch;
}

void _putchar(char character)
{
    if (character == '\n')
        low_uart_put('\r');
    low_uart_put(character);
}


int print(char* s){
    char c = s[0];
    int i = 0;
    while(c){
        _putchar(c);
        c = s[++i];
    }
    return i;
}

int main() {
    send_usb_response(1,0,1);

    print("Sending pattern\n");
    usbdl_put_dword(0xA1A2A3A4);

    *sla_passed = 1;
    *skip_auth_1 = 1;
    *skip_auth_2 = -1;

    print("Waiting for handshake\n");
    const char sequence[] = {0xA0, 0x0A, 0x50, 0x05};
    unsigned int index = 0;
    unsigned char hs = 0;

    do {
        while (1) {
            usbdl_get_data(&hs, 1);
            if(sequence[index] == hs) break;
            
            index = 0;
        }
        
        hs = ~hs;
        usbdl_put_data(&hs, 1);
        hs = 0;
        index += 1;
    } while(index != 4);

    print("Handshake completed\n");

}
